<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spanish Sentence Processor</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Spanish Verb Trainer</h1>
            <nav>
                <a href="index.html" class="nav-link">Generate Verbs</a>
                <a href="sentences.html" class="nav-link active">Process Sentences</a>
                <a href="study.html" class="nav-link">Study Cards</a>
            </nav>
        </header>

        <main>
            <section class="processor-section">
                <h2>Sentence Processor</h2>
                <p>Import Spanish sentences from TV shows, books, or music. AI will correct typos, add accents, and provide translations with grammar analysis.</p>
                
                <div class="input-section">
                    <form id="sentenceForm">
                        <div class="form-group">
                            <label for="sentenceInput">Spanish Text:</label>
                            <textarea 
                                id="sentenceInput" 
                                placeholder="Paste Spanish sentences here... (from Netflix, books, lyrics, etc.)"
                                rows="6"
                                required
                            ></textarea>
                            <small class="input-hint">Tip: Paste multiple sentences at once. AI will process each one separately.</small>
                        </div>
                        <button type="submit" id="processBtn">
                            <span class="btn-text">Process Sentences</span>
                            <span class="spinner" style="display: none;">Processing...</span>
                        </button>
                    </form>
                </div>

                <div id="loadingSection" class="loading-section" style="display: none;">
                    <div class="loading-animation">
                        <div class="spinner-large">üìù</div>
                        <p>Processing sentences with Gemma3n...</p>
                        <small>Correcting text, analyzing grammar, and generating translations</small>
                    </div>
                </div>

                <div id="resultsSection" class="results-section" style="display: none;">
                    <div class="processed-sentences">
                        <h3>Processed Sentences</h3>
                        <div class="stats">
                            <span id="sentenceCount">0 sentences processed</span>
                        </div>
                        
                        <div class="sentences-grid" id="sentencesGrid">
                            <!-- Processed sentences will be inserted here -->
                        </div>
                        
                        <div class="action-buttons">
                            <button id="saveAllBtn" class="btn-primary">
                                Save All as Study Cards
                            </button>
                            <button id="processAnotherBtn" class="btn-secondary">
                                Process More Sentences
                            </button>
                        </div>
                    </div>
                </div>

                <div id="errorSection" class="error-section" style="display: none;">
                    <div class="error-message">
                        <h4>Processing Failed</h4>
                        <p id="errorText"></p>
                        <button id="retryBtn" class="btn-secondary">Try Again</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Use the same app.js but extend it for sentence processing
        const API_BASE = window.location.hostname === 'localhost' 
            ? 'http://localhost:8000' 
            : 'https://spanish-flashcards-production.up.railway.app';

        let currentSentenceData = null;

        // DOM Elements
        const sentenceForm = document.getElementById('sentenceForm');
        const sentenceInput = document.getElementById('sentenceInput');
        const processBtn = document.getElementById('processBtn');
        const loadingSection = document.getElementById('loadingSection');
        const resultsSection = document.getElementById('resultsSection');
        const errorSection = document.getElementById('errorSection');
        const saveAllBtn = document.getElementById('saveAllBtn');
        const processAnotherBtn = document.getElementById('processAnotherBtn');
        const retryBtn = document.getElementById('retryBtn');

        // Event Listeners
        sentenceForm.addEventListener('submit', handleSentenceSubmission);
        saveAllBtn.addEventListener('click', saveSentenceCards);
        processAnotherBtn.addEventListener('click', resetForm);
        retryBtn.addEventListener('click', () => {
            if (currentSentenceData?.originalText) {
                processSentences(currentSentenceData.originalText);
            }
        });

        // Handle form submission
        async function handleSentenceSubmission(e) {
            e.preventDefault();
            const text = sentenceInput.value.trim();
            
            if (!text) {
                showError('Please enter some Spanish text');
                return;
            }
            
            await processSentences(text);
        }

        // Process sentences
        async function processSentences(text) {
            showLoading();
            currentSentenceData = { originalText: text };
            
            try {
                const response = await fetch(`${API_BASE}/api/process-sentence`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ sentence: text })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                currentSentenceData = { ...currentSentenceData, ...data };
                displayResults(data);
                
            } catch (error) {
                console.error('Processing error:', error);
                showError(error.message || 'Failed to process sentences');
            }
        }

        // Display processed results
        function displayResults(data) {
            hideAllSections();
            
            const sentencesGrid = document.getElementById('sentencesGrid');
            const sentenceCount = document.getElementById('sentenceCount');
            
            if (data.processed_sentences && data.processed_sentences.length > 0) {
                // Create cards for multiple sentences with indices
                sentencesGrid.innerHTML = data.processed_sentences
                    .map((sentence, index) => createSentenceCard(sentence, index))
                    .join('');
                sentenceCount.textContent = `${data.processed_sentences.length} sentences processed`;
                
                // Store data globally for editing
                currentSentenceData = data;
            } else if (data.corrected_spanish) {
                // Handle single sentence (backward compatibility)
                sentencesGrid.innerHTML = createSentenceCard(data, 0);
                sentenceCount.textContent = '1 sentence processed';
                
                // Store single sentence data
                currentSentenceData = { processed_sentences: [data] };
            } else {
                sentencesGrid.innerHTML = '<p class="no-sentences">No sentences processed</p>';
                sentenceCount.textContent = '0 sentences processed';
            }
            
            resultsSection.style.display = 'block';
        }

        // Create sentence card display
        function createSentenceCard(data, index = 0) {
            return `
                <div class="sentence-card" data-sentence="${index}">
                    <div class="sentence-header">
                        <h4>Processed Sentence</h4>
                        <button class="edit-btn" onclick="toggleEdit(${index})">
                            <span class="edit-text">Edit</span>
                            <span class="save-text" style="display: none;">Save</span>
                        </button>
                    </div>
                    <div class="sentence-content">
                        <div class="spanish-section">
                            <label>Corrected Spanish:</label>
                            <p class="corrected-spanish editable-text" data-field="corrected_spanish">${data.corrected_spanish || data.spanish_sentence || 'No correction provided'}</p>
                            <input type="text" class="edit-input" data-field="corrected_spanish" value="${data.corrected_spanish || data.spanish_sentence || ''}" style="display: none;">
                        </div>
                        <div class="english-section">
                            <label>English Translation:</label>
                            <p class="english-translation editable-text" data-field="english_translation">${data.english_translation || 'No translation provided'}</p>
                            <input type="text" class="edit-input" data-field="english_translation" value="${data.english_translation || ''}" style="display: none;">
                        </div>
                        <div class="verb-section">
                            <label>Verb Info:</label>
                            <p class="verb-info editable-text" data-field="verb_info">${data.verb_info || 'No verbs identified'}</p>
                            <input type="text" class="edit-input" data-field="verb_info" value="${data.verb_info || ''}" style="display: none;">
                        </div>
                        <div class="edit-actions" style="display: none;">
                            <button class="cancel-edit-btn" onclick="cancelEdit(${index})">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Save sentence cards
        async function saveSentenceCards() {
            if (!currentSentenceData) {
                showError('No sentences to save');
                return;
            }
            
            saveAllBtn.disabled = true;
            saveAllBtn.innerHTML = 'Saving...';
            
            try {
                let sentencesToSave = [];
                
                // Handle multiple sentences or single sentence
                if (currentSentenceData.processed_sentences) {
                    sentencesToSave = currentSentenceData.processed_sentences.map(sentence => ({
                        spanish_sentence: sentence.corrected_spanish || sentence.original_sentence,
                        english_translation: sentence.english_translation,
                        grammar_notes: sentence.verb_info || ''
                    }));
                } else {
                    // Single sentence (backward compatibility)
                    sentencesToSave = [{
                        spanish_sentence: currentSentenceData.corrected_spanish || currentSentenceData.spanish_sentence,
                        english_translation: currentSentenceData.english_translation,
                        grammar_notes: currentSentenceData.verb_info || ''
                    }];
                }
                
                const response = await fetch(`${API_BASE}/api/cards`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sentence_cards: sentencesToSave
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to save cards: ${response.statusText}`);
                }
                
                // Show success
                saveAllBtn.innerHTML = `${sentencesToSave.length} Cards Saved!`;
                saveAllBtn.classList.add('success');
                
                // Reset button after 2 seconds
                setTimeout(() => {
                    saveAllBtn.disabled = false;
                    saveAllBtn.innerHTML = 'Save All as Study Cards';
                    saveAllBtn.classList.remove('success');
                }, 2000);
                
            } catch (error) {
                console.error('Save error:', error);
                showError(error.message || 'Failed to save sentences');
                
                saveAllBtn.disabled = false;
                saveAllBtn.innerHTML = 'Save All as Study Cards';
            }
        }

        // Utility functions
        function resetForm() {
            hideAllSections();
            sentenceInput.value = '';
            sentenceInput.focus();
            currentSentenceData = null;
        }

        function showLoading() {
            hideAllSections();
            loadingSection.style.display = 'block';
            processBtn.disabled = true;
        }

        function showError(message) {
            hideAllSections();
            document.getElementById('errorText').textContent = message;
            errorSection.style.display = 'block';
            processBtn.disabled = false;
        }

        function hideAllSections() {
            loadingSection.style.display = 'none';
            resultsSection.style.display = 'none';
            errorSection.style.display = 'none';
            processBtn.disabled = false;
        }

        // Focus on textarea when page loads
        document.addEventListener('DOMContentLoaded', () => {
            sentenceInput.focus();
        });

        // Editing functionality
        function toggleEdit(index) {
            const card = document.querySelector(`[data-sentence="${index}"]`);
            const isEditing = card.classList.contains('editing');
            
            if (isEditing) {
                saveEdit(index);
            } else {
                enterEditMode(index);
            }
        }

        function enterEditMode(index) {
            const card = document.querySelector(`[data-sentence="${index}"]`);
            const editBtn = card.querySelector('.edit-btn');
            const editText = editBtn.querySelector('.edit-text');
            const saveText = editBtn.querySelector('.save-text');
            const editActions = card.querySelector('.edit-actions');
            
            // Switch to editing mode
            card.classList.add('editing');
            editText.style.display = 'none';
            saveText.style.display = 'inline';
            editActions.style.display = 'block';
            
            // Hide text, show inputs
            const textElements = card.querySelectorAll('.editable-text');
            const inputElements = card.querySelectorAll('.edit-input');
            
            textElements.forEach(el => el.style.display = 'none');
            inputElements.forEach(el => {
                el.style.display = 'block';
                // Copy current text to input value
                const field = el.dataset.field;
                const textEl = card.querySelector(`[data-field="${field}"].editable-text`);
                el.value = textEl.textContent;
            });
            
            // Focus on first input
            const firstInput = card.querySelector('.edit-input');
            if (firstInput) firstInput.focus();
        }

        function saveEdit(index) {
            const card = document.querySelector(`[data-sentence="${index}"]`);
            const editBtn = card.querySelector('.edit-btn');
            const editText = editBtn.querySelector('.edit-text');
            const saveText = editBtn.querySelector('.save-text');
            const editActions = card.querySelector('.edit-actions');
            
            // Get edited values
            const inputs = card.querySelectorAll('.edit-input');
            const editedData = {};
            
            inputs.forEach(input => {
                const field = input.dataset.field;
                editedData[field] = input.value;
            });
            
            // Update the stored data
            if (currentSentenceData.processed_sentences) {
                currentSentenceData.processed_sentences[index] = {
                    ...currentSentenceData.processed_sentences[index],
                    corrected_spanish: editedData.corrected_spanish,
                    english_translation: editedData.english_translation,
                    verb_info: editedData.verb_info
                };
            }
            
            // Update display
            const textElements = card.querySelectorAll('.editable-text');
            textElements.forEach(el => {
                const field = el.dataset.field;
                el.textContent = editedData[field] || 'Not provided';
                el.style.display = 'block';
            });
            
            // Hide inputs and exit edit mode
            const inputElements = card.querySelectorAll('.edit-input');
            inputElements.forEach(el => el.style.display = 'none');
            
            card.classList.remove('editing');
            editText.style.display = 'inline';
            saveText.style.display = 'none';
            editActions.style.display = 'none';
        }

        function cancelEdit(index) {
            const card = document.querySelector(`[data-sentence="${index}"]`);
            const editBtn = card.querySelector('.edit-btn');
            const editText = editBtn.querySelector('.edit-text');
            const saveText = editBtn.querySelector('.save-text');
            const editActions = card.querySelector('.edit-actions');
            
            // Exit edit mode without saving
            card.classList.remove('editing');
            editText.style.display = 'inline';
            saveText.style.display = 'none';
            editActions.style.display = 'none';
            
            // Show text, hide inputs
            const textElements = card.querySelectorAll('.editable-text');
            const inputElements = card.querySelectorAll('.edit-input');
            
            textElements.forEach(el => el.style.display = 'block');
            inputElements.forEach(el => el.style.display = 'none');
        }
    </script>
</body>
</html>
